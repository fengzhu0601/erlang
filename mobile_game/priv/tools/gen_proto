#!/bin/bash -
#===============================================================================
#
#          FILE: gen_proto.sh
#
#===============================================================================



echo "---------------------------------- begin gen_client ---------------------------------"

set -o nounset                              # Treat unset variables as an error
source priv/proto/all_protos


SOURCE_PROTO_DIR="priv/proto"
DEST_PROTO_DIR=src/auto/proto
SPROTOC="priv/tools/sprotoc"
ALL_MODS_INL="$DEST_PROTO_DIR/all_mods.inl"
PROTO_INFO_ERL="$DEST_PROTO_DIR/proto_info.erl"
INC_FILE="$DEST_PROTO_DIR/inc.hrl"



## proto
echo "-- begin gen proto --"
for ((i=0; i< ${#PROTOS[@]}; i+=3))
do
    if [ ${PROTOS[$i+1]} != nil ] ; then
        echo "gen ${PROTOS[$i+1]} -> $DEST_PROTO_DIR"
        $SPROTOC -m s -x "${PROTOS[$i+2]}" -d "$DEST_PROTO_DIR"  "$SOURCE_PROTO_DIR/${PROTOS[$i+1]}"
        if [ $? != 0 ]
        then
            echo "About"
            exit 1
        fi
    fi
done
echo "-- end gen proto --"


## all_mods.inl
echo "-- begin $ALL_MODS_INL --"
rm -rf  "$ALL_MODS_INL"
touch $ALL_MODS_INL
for ((i=0; i< ${#PROTOS[@]}; i+=3))
do
    pro=$(echo ${PROTOS[$i+1]} | sed "s/\.sproto/_sproto/g")
    echo "get_proto_mod(${PROTOS[$i+2]}) -> {${PROTOS[$i]}, $pro};" >> $ALL_MODS_INL
done
echo "get_proto_mod(_) -> nil." >> $ALL_MODS_INL
echo "-- end $ALL_MODS_INL --"



## proto_info.erl
echo "-- begin $PROTO_INFO_ERL --"
rm -rf  "$PROTO_INFO_ERL"
## to_s
cat << END > $PROTO_INFO_ERL
%%%% Auto generated by gen_proto
%%%% Don't edit it


-module(proto_info).
-export([to_s/1]).

-include("$ALL_MODS_INL").
to_s(CmdId) ->
    ModId = CmdId bsr 8,
    case get_proto_mod(ModId) of
        nil -> <<"unknonw cmdID">>;
        {_Mod, SprotoMod} ->
             SprotoMod:to_s(CmdId)
    end.
END
echo "-- end $PROTO_INFO_ERL --"



## inc.hrl
echo "-- begin $INC_FILE --"
rm -rf  "$INC_FILE"


ALL_PLAYER_MODS=
ALL_PLAYER_ENG_MODS=
ALL_INCS=
ALL_MOD_ID=
for ((i=0; i< ${#PROTOS[@]}; i+=3))
do
    mod=$(echo "${PROTOS[$i]}" | tr [:lower:] [:upper:])
    ALL_MOD_ID+="-define($mod, ${PROTOS[$i+2]}).\n"

    if [ ${PROTOS[$i+1]} != nil ] ; then # no proto
        ALL_PLAYER_MODS+=", ${PROTOS[$i]}"
        mod=$(echo "${PROTOS[$i+1]}" | sed "s/\.sproto/_sproto\.hrl/g")
        ALL_INCS+="-include(\"$mod\").\n"
    else
        ALL_PLAYER_ENG_MODS+=", ${PROTOS[$i]}"
    fi
done


ALL_PLAYER_MODS=$(echo $ALL_PLAYER_MODS | sed "s/^, //g")
ALL_PLAYER_ENG_MODS=$(echo $ALL_PLAYER_ENG_MODS | sed "s/^, //g")

#cat << END > $INC_FILE
echo -e "%%%% Auto generated by gen_proto" > $INC_FILE
echo -e "%%%% Don't edit it.\n" >> $INC_FILE

echo -e "-ifndef(GPROTO_INC_)." >> $INC_FILE
echo -e "-define(GPROTO_INC_,1).\n" >> $INC_FILE

echo -e "$ALL_MOD_ID" >> $INC_FILE
echo -e "$ALL_INCS" >> $INC_FILE
##echo -e "-define(all_player_mods(), [$ALL_PLAYER_MODS])." >> $INC_FILE
##echo -e "-define(all_player_eng_mods(), [$ALL_PLAYER_ENG_MODS])." >> $INC_FILE

echo -endif. >> $INC_FILE

echo "-- end $INC_FILE --"

echo "---------------------------------- end gen_client ---------------------------------"